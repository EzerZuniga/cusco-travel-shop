// Swiper 8.4.7 - Core
class Swiper {
  constructor(container, params = {}) {
    this.container = typeof container === 'string' ? document.querySelector(container) : container;
    this.params = this.extendParams(params);
    this.init();
  }

  extendParams(params) {
    const defaults = {
      direction: 'horizontal',
      touchEventsTarget: 'container',
      initialSlide: 0,
      speed: 300,
      cssMode: false,
      updateOnWindowResize: true,
      nested: false,
      createElements: false,
      enabled: true,
      // Modules
      a11y: true,
      navigation: false,
      pagination: false,
      scrollbar: false
    };
    return { ...defaults, ...params };
  }

  init() {
    if (!this.container || !this.container.swiper) {
      this.container.swiper = this;
      this.setupHTML();
      this.initEvents();
      this.update();
      if (this.params.enabled) this.enable();
    }
  }

  setupHTML() {
    this.wrapper = this.container.querySelector('.swiper-wrapper');
    this.slides = Array.from(this.wrapper.querySelectorAll('.swiper-slide'));
    
    if (this.params.navigation) this.initNavigation();
    if (this.params.pagination) this.initPagination();
  }

  initNavigation() {
    this.navigation = {
      nextEl: this.container.querySelector('.swiper-button-next'),
      prevEl: this.container.querySelector('.swiper-button-prev')
    };

    if (this.navigation.nextEl) {
      this.navigation.nextEl.addEventListener('click', () => this.slideNext());
    }
    if (this.navigation.prevEl) {
      this.navigation.prevEl.addEventListener('click', () => this.slidePrev());
    }
  }

  initPagination() {
    this.pagination = {
      el: this.container.querySelector('.swiper-pagination')
    };
    this.updatePagination();
  }

  updatePagination() {
    if (!this.pagination?.el) return;
    
    this.pagination.el.innerHTML = this.slides.map((_, index) => 
      `<span class="swiper-pagination-bullet" data-index="${index}"></span>`
    ).join('');

    this.pagination.bullets = Array.from(this.pagination.el.querySelectorAll('.swiper-pagination-bullet'));
    this.pagination.bullets.forEach(bullet => {
      bullet.addEventListener('click', (e) => {
        const index = parseInt(e.target.getAttribute('data-index'));
        this.slideTo(index);
      });
    });
  }

  initEvents() {
    this.onTouchStart = this.onTouchStart.bind(this);
    this.onTouchMove = this.onTouchMove.bind(this);
    this.onTouchEnd = this.onTouchEnd.bind(this);
    this.onResize = this.onResize.bind(this);

    this.container.addEventListener('touchstart', this.onTouchStart, { passive: true });
    this.container.addEventListener('touchmove', this.onTouchMove, { passive: true });
    this.container.addEventListener('touchend', this.onTouchEnd);
    window.addEventListener('resize', this.onResize);
  }

  onTouchStart(e) {
    if (!this.params.enabled) return;
    this.touchStart = {
      x: e.touches[0].clientX,
      y: e.touches[0].clientY,
      time: Date.now()
    };
  }

  onTouchMove(e) {
    if (!this.touchStart) return;
    
    const touch = e.touches[0];
    const diffX = touch.clientX - this.touchStart.x;
    const diffY = touch.clientY - this.touchStart.y;
    
    if (Math.abs(diffX) > Math.abs(diffY)) {
      e.preventDefault();
    }
  }

  onTouchEnd(e) {
    if (!this.touchStart) return;
    
    const touch = e.changedTouches[0];
    const diffX = touch.clientX - this.touchStart.x;
    const diffY = touch.clientY - this.touchStart.y;
    const timeDiff = Date.now() - this.touchStart.time;
    
    if (timeDiff < 300 && Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
      if (diffX > 0) {
        this.slidePrev();
      } else {
        this.slideNext();
      }
    }
    
    this.touchStart = null;
  }

  onResize() {
    this.update();
  }

  update() {
    this.slideWidth = this.container.offsetWidth;
    this.maxTranslate = -this.slideWidth * (this.slides.length - 1);
    this.slides.forEach((slide, index) => {
      slide.style.transform = `translate3d(${index * this.slideWidth}px, 0, 0)`;
    });
    this.translateTo(this.currentTranslate || 0);
  }

  translateTo(translate) {
    this.currentTranslate = Math.max(this.maxTranslate, Math.min(0, translate));
    this.wrapper.style.transform = `translate3d(${this.currentTranslate}px, 0, 0)`;
    this.updateActiveSlide();
  }

  updateActiveSlide() {
    const activeIndex = Math.round(-this.currentTranslate / this.slideWidth);
    this.slides.forEach((slide, index) => {
      slide.classList.toggle('swiper-slide-active', index === activeIndex);
    });
    
    if (this.pagination?.bullets) {
      this.pagination.bullets.forEach((bullet, index) => {
        bullet.classList.toggle('swiper-pagination-bullet-active', index === activeIndex);
      });
    }
  }

  slideTo(index) {
    const targetTranslate = -index * this.slideWidth;
    this.animateTo(targetTranslate);
  }

  slideNext() {
    const currentIndex = Math.round(-this.currentTranslate / this.slideWidth);
    if (currentIndex < this.slides.length - 1) {
      this.slideTo(currentIndex + 1);
    }
  }

  slidePrev() {
    const currentIndex = Math.round(-this.currentTranslate / this.slideWidth);
    if (currentIndex > 0) {
      this.slideTo(currentIndex - 1);
    }
  }

  animateTo(targetTranslate) {
    const startTranslate = this.currentTranslate;
    const startTime = Date.now();
    const duration = this.params.speed;

    const animate = () => {
      const currentTime = Date.now();
      const progress = Math.min(1, (currentTime - startTime) / duration);
      const easeProgress = this.ease(progress);
      const currentTranslate = startTranslate + (targetTranslate - startTranslate) * easeProgress;
      
      this.translateTo(currentTranslate);

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    };

    requestAnimationFrame(animate);
  }

  ease(t) {
    return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
  }

  enable() {
    this.params.enabled = true;
  }

  disable() {
    this.params.enabled = false;
  }

  destroy() {
    this.container.removeEventListener('touchstart', this.onTouchStart);
    this.container.removeEventListener('touchmove', this.onTouchMove);
    this.container.removeEventListener('touchend', this.onTouchEnd);
    window.removeEventListener('resize', this.onResize);
    delete this.container.swiper;
  }
}

// Global initialization
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.swiper').forEach(container => {
    const params = {
      navigation: container.querySelector('.swiper-button-next') && container.querySelector('.swiper-button-prev'),
      pagination: container.querySelector('.swiper-pagination'),
      loop: container.hasAttribute('data-loop'),
      autoplay: container.getAttribute('data-autoplay') ? { delay: parseInt(container.getAttribute('data-autoplay')) } : false
    };
    new Swiper(container, params);
  });
});